<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JavaScript Events Quiz</title>
    <style>
        :root {
            --primary-color: #3498db;
            --success-color: #2ecc71;
            --error-color: #e74c3c;
            --neutral-color: #f5f5f5;
            --text-color: #333;
            --border-color: #ddd;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            line-height: 1.6;
            color: var(--text-color);
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
            background-color: #f9f9f9;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--primary-color);
        }
        
        .quiz-container {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .quiz-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            font-size: 1.2rem;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .quiz-body {
            padding: 20px;
        }
        
        .quiz-question {
            margin-bottom: 15px;
            font-weight: 500;
            line-height: 1.4;
        }
        
        .code-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (min-width: 768px) {
            .code-section {
                flex-direction: row;
            }
            
            .html-view, .result-view {
                width: 50%;
            }
        }
        
        .html-view, .result-view {
            border: 1px solid var(--border-color);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .section-header {
            background-color: #f0f0f0;
            padding: 8px 12px;
            font-weight: 500;
            border-bottom: 1px solid var(--border-color);
        }
        
        .html-code {
            padding: 12px;
            font-family: monospace;
            white-space: pre-wrap;
            background-color: #f8f8f8;
            overflow-x: auto;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .result-container {
            padding: 12px;
            min-height: 200px;
            background-color: white;
            overflow: auto;
        }
        
        .code-editor {
            width: 100%;
            min-height: 100px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            margin-bottom: 15px;
            resize: vertical;
            background-color: #f8f8f8;
        }
        
        .button-container {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .navigation-container {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .feedback {
            margin: 15px 0px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        
        .success {
            background-color: rgba(46, 204, 113, 0.2);
            color: var(--success-color);
            border: 1px solid var(--success-color);
            display: block;
        }
        
        .error {
            background-color: rgba(231, 76, 60, 0.2);
            color: var(--error-color);
            border: 1px solid var(--error-color);
            display: block;
        }
        
        .hints {
            margin: 10px 0px;
            color: #666;
            font-style: italic;
        }
        
        .hint-text {
            display: none;
            margin: 10px 0px;
            padding: 10px;
            background-color: #fffde7;
            border-left: 3px solid #ffd600;
        }
        
        .hint-button {
            background-color: #f5f5f5;
            color: #333;
            margin: 10px 0px;
        }
        
        .question-nav {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 8px;
            margin: 20px 0;
        }
        
        .question-btn {
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f5f5f5;
            color: #333;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .question-btn:hover {
            background-color: #e0e0e0;
        }
        
        .question-btn.current {
            background-color: var(--primary-color);
            color: white;
        }
        
        .question-btn.answered {
            background-color: var(--success-color);
            color: white;
        }
        
        .nav-btn {
            background-color: #f5f5f5;
            color: #333;
        }
        
        @media (max-width: 600px) {
            body {
                padding: 15px;
            }
            
            .quiz-header {
                padding: 12px;
                font-size: 1.1rem;
            }
            
            .quiz-body {
                padding: 15px;
            }
            
            button {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            
            .code-editor {
                min-height: 80px;
            }
            
            .question-btn {
                width: 35px;
                height: 35px;
                font-size: 0.9rem;
            }
            
            .navigation-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .navigation-container button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <h1>JavaScript Events Quiz</h1>
    
    <div id="quizContainer" class="quiz-container">
        <div class="quiz-header">
            <div>Question <span id="questionNumber">1</span> of <span id="totalQuestions">10</span></div>
            <div>Score: <span id="currentScore">0</span>/<span id="totalQuestions2">10</span></div>
        </div>
        
        <div class="question-nav" id="questionNav">
            <!-- Question navigation buttons will be generated here -->
        </div>
        
        <div class="quiz-body">
            <div class="quiz-question" id="question"></div>
            
            <div class="code-section">
                <div class="html-view">
                    <div class="section-header">HTML Code</div>
                    <pre class="html-code" id="htmlCode"></pre>
                </div>
                <div class="result-view">
                    <div class="section-header">Result (Preview)</div>
                    <div class="result-container" id="resultContainer"></div>
                </div>
            </div>
            
            <div class="section-header">Your JavaScript Code</div>
            <textarea class="code-editor" id="codeEditor" spellcheck="false"></textarea>
            
            <div class="hints">
                <button class="hint-button" id="hintButton">Show Hint</button>
                <div class="hint-text" id="hintText"></div>
            </div>
            
            <div class="feedback" id="feedback"></div>
            
            <div class="button-container">
                <button id="checkButton">Check Answer</button>
                <button id="resetButton">Reset Code</button>
                <button id="runButton">Run Code</button>
            </div>
            
            <div class="navigation-container">
                <button class="nav-btn" id="prevButton">Previous Question</button>
                <button class="nav-btn" id="nextButton">Next Question</button>
            </div>
        </div>
    </div>
    
    <script>
        // Quiz questions with HTML, test cases, and hints
        const questions = [
            {
                question: "Add a click event listener to the button that changes the text of the paragraph to 'Button was clicked!'",
                html: `<div>
  <button id="clickButton">Click Me</button>
  <p id="output">This text will change when the button is clicked.</p>
</div>`,
                testFunction: function(resultElement) {
                    const button = resultElement.querySelector('#clickButton');
                    const output = resultElement.querySelector('#output');
                    
                    // Simulate a click
                    if (button && output) {
                        const originalText = output.textContent;
                        button.click();
                        return output.textContent !== originalText && output.textContent === 'Button was clicked!';
                    }
                    return false;
                },
                hint: "Use document.getElementById('clickButton').addEventListener('click', function() { ... }) to attach a click event handler to the button.",
                userCode: '',
                answered: false,
                correct: false
            },
            {
                question: "Add mouseover and mouseout event listeners to the box that change its background color to yellow on mouseover and back to lightgray on mouseout.",
                html: `<div>
  <div id="hoverBox" style="width: 200px; height: 100px; background-color: lightgray; display: flex; justify-content: center; align-items: center; margin: 20px auto;">
    Hover over me
  </div>
</div>`,
                testFunction: function(resultElement) {
                    const box = resultElement.querySelector('#hoverBox');
                    if (!box) return false;
                    
                    // Store original background color
                    const originalBgColor = window.getComputedStyle(box).backgroundColor;
                    
                    // Simulate mouseover
                    const mouseoverEvent = new MouseEvent('mouseover');
                    box.dispatchEvent(mouseoverEvent);
                    
                    // Check if background changed to yellow
                    const afterHoverBgColor = window.getComputedStyle(box).backgroundColor;
                    const isYellow = afterHoverBgColor === 'rgb(255, 255, 0)' || afterHoverBgColor === 'yellow';
                    
                    // Simulate mouseout
                    const mouseoutEvent = new MouseEvent('mouseout');
                    box.dispatchEvent(mouseoutEvent);
                    
                    // Check if background changed back
                    const afterOutBgColor = window.getComputedStyle(box).backgroundColor;
                    const isBackToOriginal = afterOutBgColor === originalBgColor || afterOutBgColor === 'rgb(211, 211, 211)' || afterOutBgColor === 'lightgray';
                    
                    return isYellow && isBackToOriginal;
                },
                hint: "Use element.addEventListener('mouseover', function() { element.style.backgroundColor = 'yellow'; }) and element.addEventListener('mouseout', function() { element.style.backgroundColor = 'lightgray'; })",
                userCode: '',
                answered: false,
                correct: false
            },
            {
                question: "Add a keydown event listener to the input field that displays the pressed key in the paragraph below it.",
                html: `<div>
  <input type="text" id="keyInput" placeholder="Type something...">
  <p id="keyOutput">Press any key to see it displayed here.</p>
</div>`,
                testFunction: function(resultElement) {
                    const input = resultElement.querySelector('#keyInput');
                    const output = resultElement.querySelector('#keyOutput');
                    
                    if (!input || !output) return false;
                    
                    // Check if keydown event listener exists and works
                    const originalText = output.textContent;
                    
                    // Simulate keydown event with the letter 'A'
                    const keyEvent = new KeyboardEvent('keydown', {
                        key: 'A',
                        code: 'KeyA',
                        keyCode: 65,
                        which: 65,
                        bubbles: true
                    });
                    
                    input.dispatchEvent(keyEvent);
                    
                    // Check if the output contains the key 'A'
                    return output.textContent !== originalText && output.textContent.includes('A');
                },
                hint: "Use input.addEventListener('keydown', function(event) { document.getElementById('keyOutput').textContent = 'You pressed: ' + event.key; })",
                userCode: '',
                answered: false,
                correct: false
            },
            {
                question: "Implement form validation: Add a submit event listener to the form that prevents submission if the input field is empty and displays an error message.",
                html: `<div>
  <form id="validationForm">
    <input type="text" id="nameInput" placeholder="Enter your name">
    <button type="submit">Submit</button>
  </form>
  <p id="errorMessage" style="color: red;"></p>
</div>`,
                testFunction: function(resultElement) {
                    const form = resultElement.querySelector('#validationForm');
                    const input = resultElement.querySelector('#nameInput');
                    const errorMsg = resultElement.querySelector('#errorMessage');
                    
                    if (!form || !input || !errorMsg) return false;
                    
                    // Test with empty input
                    input.value = '';
                    
                    // Create and dispatch submit event
                    const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                    const preventDefaultCalled = !form.dispatchEvent(submitEvent);
                    
                    // Check if preventDefault was called and error message is displayed
                    const hasErrorMessage = errorMsg.textContent.trim() !== '';
                    
                    // Now test with valid input
                    input.value = 'John Doe';
                    const submitEvent2 = new Event('submit', { bubbles: true, cancelable: true });
                    const preventDefaultCalled2 = !form.dispatchEvent(submitEvent2);
                    
                    // For valid input, we don't expect preventDefault to be called
                    // But since we can't actually submit the form in this environment,
                    // we'll just check that the error message is cleared
                    const errorCleared = preventDefaultCalled && !preventDefaultCalled2 && errorMsg.textContent.trim() === '';
                    
                    return preventDefaultCalled && hasErrorMessage;
                },
                hint: "Use form.addEventListener('submit', function(event) { if (document.getElementById('nameInput').value.trim() === '') { event.preventDefault(); document.getElementById('errorMessage').textContent = 'Name is required!'; } else { document.getElementById('errorMessage').textContent = ''; } })",
                userCode: '',
                answered: false,
                correct: false
            },
            {
                question: "Create a simple event delegation: Add a single click event listener to the unordered list that displays the text of the clicked list item in the paragraph below.",
                html: `<div>
  <ul id="fruitList">
    <li>Apple</li>
    <li>Banana</li>
    <li>Cherry</li>
    <li>Date</li>
  </ul>
  <p id="selectedFruit">Click on a fruit to select it.</p>
</div>`,
                testFunction: function(resultElement) {
                    const list = resultElement.querySelector('#fruitList');
                    const output = resultElement.querySelector('#selectedFruit');
                    const listItems = resultElement.querySelectorAll('#fruitList li');
                    
                    if (!list || !output || listItems.length === 0) return false;
                    
                    // Test clicking on each list item
                    let allWorking = true;
                    
                    for (const li of listItems) {
                        const originalOutput = output.textContent;
                        const fruitName = li.textContent;
                        
                        // Simulate click
                        li.click();
                        
                        // Check if output changed and contains the fruit name
                        if (output.textContent === originalOutput || !output.textContent.includes(fruitName)) {
                            allWorking = false;
                            break;
                        }
                    }
                    
                    return allWorking;
                },
                hint: "Use event delegation by adding the event listener to the parent element and checking event.target: document.getElementById('fruitList').addEventListener('click', function(event) { if (event.target.tagName === 'LI') { document.getElementById('selectedFruit').textContent = 'Selected: ' + event.target.textContent; } })",
                userCode: '',
                answered: false,
                correct: false
            },
            {
                question: "Implement event propagation control: Add click event listeners to both the inner and outer divs. The inner div should stop event propagation.",
                html: `<div>
  <div id="outer" style="padding: 20px; background-color: lightblue; text-align: center;">
    Outer Div
    <div id="inner" style="padding: 20px; background-color: lightcoral; margin: 10px;">
      Inner Div
    </div>
  </div>
  <p id="clickLog">Click events will be logged here.</p>
</div>`,
                testFunction: function(resultElement) {
                    const outer = resultElement.querySelector('#outer');
                    const inner = resultElement.querySelector('#inner');
                    const log = resultElement.querySelector('#clickLog');
                    
                    if (!outer || !inner || !log) return false;
                    
                    // Clear the log
                    log.textContent = 'Click events will be logged here.';
                    
                    // Simulate click on outer div (not on inner)
                    const outerRect = outer.getBoundingClientRect();
                    const innerRect = inner.getBoundingClientRect();
                    
                    // Click on outer div but not on inner div
                    const outerClickX = outerRect.left + 5;
                    const outerClickY = outerRect.top + 5;
                    
                    const outerClickEvent = new MouseEvent('click', {
                        bubbles: true,
                        cancelable: true,
                        view: window,
                        clientX: outerClickX,
                        clientY: outerClickY
                    });
                    
                    outer.dispatchEvent(outerClickEvent);
                    
                    // Check if outer click was logged
                    const outerClickLogged = log.textContent.includes('outer') || log.textContent.includes('Outer');
                    
                    // Now simulate click on inner div
                    inner.click();
                    
                    // Check if inner click was logged but not propagated to outer
                    const innerClickLogged = log.textContent.includes('inner') || log.textContent.includes('Inner');
                    const noPropagation = !(log.textContent.match(/outer|Outer/g) || []).length > 1;
                    
                    return outerClickLogged && innerClickLogged && noPropagation;
                },
                hint: "Add event listeners to both divs, and use event.stopPropagation() in the inner div's handler: document.getElementById('inner').addEventListener('click', function(event) { event.stopPropagation(); document.getElementById('clickLog').textContent += '\\nInner div clicked'; })",
                userCode: '',
                answered: false,
                correct: false
            },
            {
                question: "Create a custom event: Dispatch a custom 'userLogin' event when the login button is clicked, and have a listener that updates the welcome message.",
                html: `<div>
  <button id="loginButton">Login</button>
  <p id="welcomeMessage">Please log in</p>
</div>`,
                testFunction: function(resultElement) {
                    const loginButton = resultElement.querySelector('#loginButton');
                    const welcomeMessage = resultElement.querySelector('#welcomeMessage');
                    
                    if (!loginButton || !welcomeMessage) return false;
                    
                    // Reset welcome message
                    welcomeMessage.textContent = 'Please log in';
                    
                    // Check if custom event listener exists
                    let customEventHandled = false;
                    
                    // Create a temporary event listener to check if our custom event is dispatched
                    document.addEventListener('userLogin', function tempHandler() {
                        customEventHandled = true;
                        document.removeEventListener('userLogin', tempHandler);
                    });
                    
                    // Simulate button click
                    loginButton.click();
                    
                    // Check if welcome message changed and custom event was dispatched
                    const messageChanged = welcomeMessage.textContent !== 'Please log in';
                    
                    return customEventHandled && messageChanged;
                },
                hint: "Create and dispatch a custom event: loginButton.addEventListener('click', function() { const loginEvent = new CustomEvent('userLogin', { detail: { username: 'User' } }); document.dispatchEvent(loginEvent); }); Then listen for it: document.addEventListener('userLogin', function(event) { document.getElementById('welcomeMessage').textContent = 'Welcome, ' + event.detail.username + '!'; });",
                userCode: '',
                answered: false,
                correct: false
            },
            {
                question: "Implement a simple drag functionality: Make the box draggable by using mousedown, mousemove, and mouseup events.",
                html: `<div>
  <div id="draggableBox" style="width: 100px; height: 100px; background-color: #3498db; position: absolute; top: 50px; left: 50px; cursor: move; display: flex; justify-content: center; align-items: center; color: white;">
    Drag me
  </div>
</div>`,
                testFunction: function(resultElement) {
                    const box = resultElement.querySelector('#draggableBox');
                    
                    if (!box) return false;
                    
                    // Store initial position
                    const initialLeft = parseInt(box.style.left);
                    const initialTop = parseInt(box.style.top);
                    
                    // Simulate mousedown
                    const mousedownEvent = new MouseEvent('mousedown', {
                        bubbles: true,
                        cancelable: true,
                        clientX: initialLeft,
                        clientY: initialTop
                    });
                    
                    box.dispatchEvent(mousedownEvent);
                    
                    // Simulate mousemove
                    const mousemoveEvent = new MouseEvent('mousemove', {
                        bubbles: true,
                        cancelable: true,
                        clientX: initialLeft + 50,
                        clientY: initialTop + 50
                    });
                    
                    document.dispatchEvent(mousemoveEvent);
                    
                    // Simulate mouseup
                    const mouseupEvent = new MouseEvent('mouseup', {
                        bubbles: true,
                        cancelable: true
                    });
                    
                    document.dispatchEvent(mouseupEvent);
                    
                    // Check if position changed
                    const newLeft = parseInt(box.style.left);
                    const newTop = parseInt(box.style.top);
                    
                    // Position should be different after drag
                    const positionChanged = newLeft !== initialLeft || newTop !== initialTop;
                    
                    // Check if all required event listeners were added
                    const hasMouseDownListener = typeof box.onmousedown === 'function' || box._hasMouseDownListener;
                    
                    return positionChanged || hasMouseDownListener;
                },
                hint: "Implement dragging with three event listeners: 1) box.addEventListener('mousedown', startDrag) to track when dragging starts, 2) document.addEventListener('mousemove', drag) to move the element, and 3) document.addEventListener('mouseup', stopDrag) to stop dragging. Use variables to track the initial mouse position and offset.",
                userCode: '',
                answered: false,
                correct: false
            },
            {
                question: "Create a simple keyboard navigation: Use arrow keys to move the box in four directions (up, down, left, right).",
                html: `<div style="position: relative; height: 300px; border: 1px solid #ccc;">
  <div id="movableBox" style="width: 50px; height: 50px; background-color: #e74c3c; position: absolute; top: 125px; left: 125px;"></div>
</div>
<p>Use the arrow keys to move the box. Click in the container first to give it focus.</p>`,
                testFunction: function(resultElement) {
                    // Check if keydown event listener exists
                    const hasKeydownListener = document.onkeydown !== null || document._hasKeydownListener;
                    
                    // Get the box
                    const box = resultElement.querySelector('#movableBox');
                    if (!box) return false;
                    
                    // Store initial position
                    const initialLeft = parseInt(box.style.left);
                    const initialTop = parseInt(box.style.top);
                    
                    // Simulate arrow key presses
                    const arrowKeys = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'];
                    let positionChanged = false;
                    
                    for (const key of arrowKeys) {
                        const keyEvent = new KeyboardEvent('keydown', {
                            key: key,
                            code: key,
                            bubbles: true
                        });
                        
                        document.dispatchEvent(keyEvent);
                        
                        // Check if position changed after any key press
                        const newLeft = parseInt(box.style.left);
                        const newTop = parseInt(box.style.top);
                        
                        if (newLeft !== initialLeft || newTop !== initialTop) {
                            positionChanged = true;
                            break;
                        }
                    }
                    
                    return hasKeydownListener || positionChanged;
                },
                hint: "Add a keydown event listener to the document: document.addEventListener('keydown', function(event) { const box = document.getElementById('movableBox'); const step = 10; switch(event.key) { case 'ArrowUp': box.style.top = (parseInt(box.style.top) - step) + 'px'; break; case 'ArrowDown': box.style.top = (parseInt(box.style.top) + step) + 'px'; break; case 'ArrowLeft': box.style.left = (parseInt(box.style.left) - step) + 'px'; break; case 'ArrowRight': box.style.left = (parseInt(box.style.left) + step) + 'px'; break; } });",
                userCode: '',
                answered: false,
                correct: false
            },
            {
                question: "Implement a simple event-based counter: Create a counter that increments when the '+' button is clicked and decrements when the '-' button is clicked.",
                html: `<div style="text-align: center;">
  <button id="decrementBtn">-</button>
  <span id="counterValue">0</span>
  <button id="incrementBtn">+</button>
</div>`,
                testFunction: function(resultElement) {
                    const decrementBtn = resultElement.querySelector('#decrementBtn');
                    const incrementBtn = resultElement.querySelector('#incrementBtn');
                    const counterValue = resultElement.querySelector('#counterValue');
                    
                    if (!decrementBtn || !incrementBtn || !counterValue) return false;
                    
                    // Reset counter
                    counterValue.textContent = '0';
                    
                    // Simulate increment clicks
                    incrementBtn.click();
                    incrementBtn.click();
                    
                    // Check if counter increased
                    const afterIncrement = parseInt(counterValue.textContent);
                    const incrementWorks = afterIncrement === 2;
                    
                    // Simulate decrement click
                    decrementBtn.click();
                    
                    // Check if counter decreased
                    const afterDecrement = parseInt(counterValue.textContent);
                    const decrementWorks = afterDecrement === 1;
                    
                    return incrementWorks && decrementWorks;
                },
                hint: "Add click event listeners to both buttons: document.getElementById('incrementBtn').addEventListener('click', function() { const counter = document.getElementById('counterValue'); counter.textContent = parseInt(counter.textContent) + 1; }); Do the same for the decrement button but subtract instead.",
                userCode: '',
                answered: false,
                correct: false
            }
        ];

        // Quiz state
        let currentQuestion = 0;
        let score = 0;

        // DOM elements
        const questionElement = document.getElementById('question');
        const htmlCodeElement = document.getElementById('htmlCode');
        const resultContainerElement = document.getElementById('resultContainer');
        const codeEditor = document.getElementById('codeEditor');
        const feedbackElement = document.getElementById('feedback');
        const checkButton = document.getElementById('checkButton');
        const resetButton = document.getElementById('resetButton');
        const runButton = document.getElementById('runButton');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');
        const hintButton = document.getElementById('hintButton');
        const hintText = document.getElementById('hintText');
        const questionNumberElement = document.getElementById('questionNumber');
        const totalQuestionsElement = document.getElementById('totalQuestions');
        const totalQuestionsElement2 = document.getElementById('totalQuestions2');
        const currentScoreElement = document.getElementById('currentScore');
        const questionNavElement = document.getElementById('questionNav');

        // Initialize quiz
        function initQuiz() {
            totalQuestionsElement.textContent = questions.length;
            totalQuestionsElement2.textContent = questions.length;
            createQuestionNav();
            loadQuestion(0);
            updateNavButtons();
        }

        // Create question navigation
        function createQuestionNav() {
            questionNavElement.innerHTML = '';
            for (let i = 0; i < questions.length; i++) {
                const btn = document.createElement('div');
                btn.className = 'question-btn';
                btn.textContent = i + 1;
                btn.addEventListener('click', () => {
                    saveCurrentAnswer();
                    loadQuestion(i);
                });
                questionNavElement.appendChild(btn);
            }
            updateQuestionNav();
        }

        // Update question navigation styling
        function updateQuestionNav() {
            const navButtons = questionNavElement.querySelectorAll('.question-btn');
            navButtons.forEach((btn, index) => {
                btn.classList.remove('current', 'answered');
                if (index === currentQuestion) {
                    btn.classList.add('current');
                }
                if (questions[index].answered) {
                    btn.classList.add('answered');
                }
            });
        }

        // Load question by index
        function loadQuestion(index) {
            currentQuestion = index;
            const question = questions[currentQuestion];
            
            questionElement.textContent = question.question;
            htmlCodeElement.textContent = question.html;
            codeEditor.value = question.userCode;
            
            // Reset and populate the result container
            resultContainerElement.innerHTML = question.html;
            
            if (question.answered) {
                if (question.correct) {
                    feedbackElement.className = 'feedback success';
                    feedbackElement.textContent = 'Correct! Well done!';
                } else {
                    feedbackElement.className = 'feedback error';
                    feedbackElement.textContent = 'That\'s not quite right. You can try again!';
                }
            } else {
                feedbackElement.className = 'feedback';
                feedbackElement.textContent = '';
            }
            
            questionNumberElement.textContent = currentQuestion + 1;
            hintText.style.display = 'none';
            
            updateQuestionNav();
            updateNavButtons();
            updateScore();
        }

        // Save current answer
        function saveCurrentAnswer() {
            questions[currentQuestion].userCode = codeEditor.value;
        }

        // Run the user's code
        function runCode() {
            saveCurrentAnswer();
            
            const userCode = questions[currentQuestion].userCode.trim();
            
            if (userCode === '') {
                feedbackElement.className = 'feedback error';
                feedbackElement.textContent = 'Please write some code before running.';
                return;
            }
            
            // Reset the result container with the original HTML
            resultContainerElement.innerHTML = questions[currentQuestion].html;
            
            try {
                // Create a function that will run in the context of the result container
                const executeCode = new Function('document', userCode);
                
                // Create a proxy document object that redirects methods to the result container
                const proxyDocument = {
                    getElementById: (id) => resultContainerElement.querySelector(`#${id}`),
                    getElementsByClassName: (className) => resultContainerElement.querySelectorAll(`.${className}`),
                    getElementsByTagName: (tagName) => resultContainerElement.querySelectorAll(tagName),
                    querySelector: (selector) => resultContainerElement.querySelector(selector),
                    querySelectorAll: (selector) => resultContainerElement.querySelectorAll(selector),
                    addEventListener: (type, handler) => {
                        document._hasKeydownListener = true;
                        return document.addEventListener(type, handler);
                    },
                    dispatchEvent: (event) => document.dispatchEvent(event),
                    createEvent: (type) => document.createEvent(type),
                    createElement: (tag) => document.createElement(tag)
                };
                
                // Add a flag to track if mousedown listener was added to the box
                const draggableBox = resultContainerElement.querySelector('#draggableBox');
                if (draggableBox) {
                    const originalAddEventListener = draggableBox.addEventListener;
                    draggableBox.addEventListener = function(type, handler) {
                        if (type === 'mousedown') {
                            this._hasMouseDownListener = true;
                        }
                        return originalAddEventListener.call(this, type, handler);
                    };
                }
                
                // Execute the user's code with the proxy document
                executeCode(proxyDocument);
                
                feedbackElement.className = 'feedback';
                feedbackElement.textContent = 'Code executed. Check the result.';
            } catch (error) {
                feedbackElement.className = 'feedback error';
                feedbackElement.textContent = `Error: ${error.message}`;
            }
        }

        // Check the answer
        function checkAnswer() {
            saveCurrentAnswer();
            
            const userCode = questions[currentQuestion].userCode.trim();
            
            if (userCode === '') {
                feedbackElement.className = 'feedback error';
                feedbackElement.textContent = 'Please write some code before checking.';
                return;
            }
            
            // Run the code first
            runCode();
            
            // Then check if the result is correct
            const isCorrect = questions[currentQuestion].testFunction(resultContainerElement);
            
            questions[currentQuestion].answered = true;
            questions[currentQuestion].correct = isCorrect;
            
            if (isCorrect) {
                feedbackElement.className = 'feedback success';
                feedbackElement.textContent = 'Correct! Well done!';
                if (!questions[currentQuestion].correct) {
                    score++;
                    updateScore();
                }
            } else {
                feedbackElement.className = 'feedback error';
                feedbackElement.textContent = 'That\'s not quite right. You can try again!';
            }
            
            updateQuestionNav();
        }

        // Reset current question code
        function resetCode() {
            codeEditor.value = '';
            questions[currentQuestion].userCode = '';
            feedbackElement.className = 'feedback';
            feedbackElement.textContent = '';
            
            // Reset the result container
            resultContainerElement.innerHTML = questions[currentQuestion].html;
        }

        // Navigate to previous question
        function prevQuestion() {
            if (currentQuestion > 0) {
                saveCurrentAnswer();
                loadQuestion(currentQuestion - 1);
            }
        }

        // Navigate to next question
        function nextQuestion() {
            if (currentQuestion < questions.length - 1) {
                saveCurrentAnswer();
                loadQuestion(currentQuestion + 1);
            }
        }

        // Update navigation buttons state
        function updateNavButtons() {
            prevButton.disabled = currentQuestion === 0;
            nextButton.disabled = currentQuestion === questions.length - 1;
        }

        // Show hint
        function showHint() {
            const hint = questions[currentQuestion].hint;
            hintText.textContent = hint;
            hintText.style.display = 'block';
        }

        // Calculate score
        function calculateScore() {
            score = 0;
            for (const question of questions) {
                if (question.correct) {
                    score++;
                }
            }
            return score;
        }

        // Update score display
        function updateScore() {
            score = calculateScore();
            currentScoreElement.textContent = score;
        }

        // Event listeners
        checkButton.addEventListener('click', checkAnswer);
        resetButton.addEventListener('click', resetCode);
        runButton.addEventListener('click', runCode);
        prevButton.addEventListener('click', prevQuestion);
        nextButton.addEventListener('click', nextQuestion);
        hintButton.addEventListener('click', showHint);

        // Initialize the quiz
        initQuiz();
    </script>
</body>
</html>
